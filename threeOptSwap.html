<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Travelling Salesman Problem Visualisierung - Three-Opt</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
</head>
<body>
<label for="tspSelect">Wähle eine TSP Datei:</label>
<select id="tspSelect">
  <option value="" disabled selected>Wähle eine TSP Datei</option>
  <option value="ulysses16.tsp">Ulysses 16</option>
  <option value="berlin52.tsp">Berlin 52</option>
  <option value="bier127.tsp">Bier 127</option>
  <option value="a280.tsp">A 280</option>
  <option value="rl1304.tsp">RL 1304</option>
</select>

<div id="tourLength">Tour Länge: N/A</div>
<div id="swapCount">Anzahl der Swaps: 0</div>
<label for="stepByStep">Schritt-für-Schritt-Visualisierung:</label>
<input type="checkbox" id="stepByStep">
<button id="startButton">3-Opt Optimierung starten</button>

<script>
  let cities = [];
  let bestEver = [];
  let swapCounter = 0;
  let xMin, xMax, yMin, yMax;
  let i = 1, j = 2, k = 3, improved = false;
  let tourLength = 0;
  let showStepByStep = false;
  let optimizationStarted = false;

  const filePaths = {
    'ulysses16.tsp': 'TSPData/ulysses16.tsp',
    'berlin52.tsp': 'TSPData/berlin52.tsp',
    'bier127.tsp': 'TSPData/bier127.tsp',
    'a280.tsp': 'TSPData/a280.tsp',
    'rl1304.tsp': 'TSPData/rl1304.tsp'
  };

  document.getElementById('tspSelect').addEventListener('change', handleSelectChange);
  document.getElementById('startButton').addEventListener('click', startOptimization);

  function handleSelectChange(event) {
    const selectedFile = event.target.value;
    const filePath = filePaths[selectedFile];
    loadTSPFile(filePath);

    const stepByStepChecked = document.getElementById('stepByStep').checked;
    showStepByStep = stepByStepChecked;

    optimizationStarted = false;
    noLoop(); // Stop the loop until the button is clicked
  }

  function startOptimization() {
    if (showStepByStep) {
      optimizationStarted = true;
      frameRate(60);
      loop();
    } else {
      performComplete3Opt();
      draw();
    }
  }

  function loadTSPFile(filepath) {
    fetch(filepath)
            .then(response => response.text())
            .then(data => {
              loadCities(data);
              noLoop();
              draw();
            });
  }

  function loadCities(data) {
    let lines = data.trim().split('\n');
    let coordSection = false;
    cities = [];
    for (let line of lines) {
      line = line.trim();
      if (line === 'NODE_COORD_SECTION') {
        coordSection = true;
        continue;
      }
      if (line === 'EOF' || line === '' || !coordSection) {
        coordSection = false;
        continue;
      }
      let parts = line.split(/\s+/);
      let v = createVector(parseFloat(parts[1]), parseFloat(parts[2]));
      cities.push(v);
    }
    bestEver = cities.slice();
    i = 1;
    j = 2;
    k = 3;
    improved = false;
    swapCounter = 0;
    calculateBounds();
  }

  function calculateBounds() {
    if (cities.length > 0) {
      xMin = Math.min(...cities.map(city => city.x));
      xMax = Math.max(...cities.map(city => city.x));
      yMin = Math.min(...cities.map(city => city.y));
      yMax = Math.max(...cities.map(city => city.y));
    } else {
      console.error("No cities loaded!");
    }
  }

  function setup() {
    createCanvas(1200, 800);
    background(255);
    noLoop();
  }

  function draw() {
    background(255);

    if (optimizationStarted && showStepByStep) {
      performStepByStep3Opt();
    }

    bestEver.forEach(city => {
      let mappedX = map(city.x, xMin, xMax, 20, width - 20);
      let mappedY = map(city.y, yMin, yMax, 20, height - 20);
      fill(0);
      ellipse(mappedX, mappedY, 4, 4);
    });

    stroke(0);
    strokeWeight(2);
    noFill();
    beginShape();
    bestEver.forEach(city => {
      let mappedX = map(city.x, xMin, xMax, 20, width - 20);
      let mappedY = map(city.y, yMin, yMax, 20, height - 20);
      vertex(mappedX, mappedY);
    });
    endShape();

    // Draw final connection to close the tour
    if (bestEver.length > 1) {
      let firstCity = bestEver[0];
      let lastCity = bestEver[bestEver.length - 1];
      let mappedX1 = map(firstCity.x, xMin, xMax, 20, width - 20);
      let mappedY1 = map(firstCity.y, yMin, yMax, 20, height - 20);
      let mappedX2 = map(lastCity.x, xMin, xMax, 20, width - 20);
      let mappedY2 = map(lastCity.y, yMin, yMax, 20, height - 20);
      line(mappedX1, mappedY1, mappedX2, mappedY2);
    }

    tourLength = calculateTourLength(bestEver);
    document.getElementById('tourLength').innerText = `Tour Länge: ${tourLength.toFixed(2)}`;
    document.getElementById('swapCount').innerText = `Anzahl der Swaps: ${swapCounter}`;
  }

  function performStepByStep3Opt() {
    if (i < bestEver.length - 2) {
      if (j < bestEver.length - 1) {
        if (k < bestEver.length) {
          let newTour = threeOptSwap(bestEver, i, j, k);
          if (calculateTourLength(newTour) < calculateTourLength(bestEver)) {
            bestEver = newTour;
            improved = true;
            swapCounter++;
            document.getElementById('swapCount').innerText = `Anzahl der Swaps: ${swapCounter}`;
            tourLength = calculateTourLength(bestEver);
            document.getElementById('tourLength').innerText = `Tour Länge: ${tourLength.toFixed(2)}`;
          }
          k++;
        } else {
          j++;
          k = j + 1;
        }
      } else {
        if (improved) {
          improved = false;
          i++;
          j = i + 1;
          k = j + 1;
        } else {
          i++;
          j = i + 1;
          k = j + 1;
        }
      }
    }

    if (i >= bestEver.length - 2) {
      tourLength = calculateTourLength(bestEver);
      document.getElementById('tourLength').innerText = `Tour Länge: ${tourLength.toFixed(2)}`;
      noLoop();
    }
  }

  function performComplete3Opt() {
    while (i < bestEver.length - 2) {
      if (j < bestEver.length - 1) {
        if (k < bestEver.length) {
          let newTour = threeOptSwap(bestEver, i, j, k);
          if (calculateTourLength(newTour) < calculateTourLength(bestEver)) {
            bestEver = newTour;
            improved = true;
            swapCounter++;
            document.getElementById('swapCount').innerText = `Anzahl der Swaps: ${swapCounter}`;
            tourLength = calculateTourLength(bestEver);
            document.getElementById('tourLength').innerText = `Tour Länge: ${tourLength.toFixed(2)}`;
          }
          k++;
        } else {
          j++;
          k = j + 1;
        }
      } else {
        if (improved) {
          improved = false;
          i++;
          j = i + 1;
          k = j + 1;
        } else {
          i++;
          j = i + 1;
          k = j + 1;
        }
      }
    }
    tourLength = calculateTourLength(bestEver);
    document.getElementById('tourLength').innerText = `Tour Länge: ${tourLength.toFixed(2)}`;
  }

  function threeOptSwap(tour, i, j, k) {
    // Create different possibilities of 3-opt swaps and select the best one
    let segments = [tour.slice(0, i), tour.slice(i, j), tour.slice(j, k), tour.slice(k)];
    let possibilities = [
      [].concat(segments[0], segments[1].reverse(), segments[2].reverse(), segments[3]),
      [].concat(segments[0], segments[2], segments[1], segments[3]),
      [].concat(segments[0], segments[2].reverse(), segments[1].reverse(), segments[3]),
      [].concat(segments[0], segments[1].reverse(), segments[2], segments[3]),
      [].concat(segments[0], segments[2].reverse(), segments[1], segments[3].reverse()),
      [].concat(segments[0], segments[1], segments[2].reverse(), segments[3].reverse())
    ];

    let bestNewTour = tour;
    let bestTourLength = calculateTourLength(tour);
    possibilities.forEach(possibleTour => {
      let possibleTourLength = calculateTourLength(possibleTour);
      if (possibleTourLength < bestTourLength) {
        bestNewTour = possibleTour;
        bestTourLength = possibleTourLength;
      }
    });

    return bestNewTour;
  }

  function calculateTourLength(tour) {
    let totalDist = 0;
    for (let i = 0; i < tour.length - 1; i++) {
      totalDist += dist(tour[i].x, tour[i].y, tour[i + 1].x, tour[i + 1].y);
    }
    totalDist += dist(tour[tour.length - 1].x, tour[tour.length - 1].y, tour[0].x, tour[0].y);
    return totalDist;
  }

</script>
</body>
</html>
